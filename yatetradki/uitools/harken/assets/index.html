<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Subtitle Editor</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.6.8/plyr.css" />
    <style>
        #container {
            display: flex;
            height: 100vh;
        }
        #player-container {
            flex: 1;
            width: 50%; /* Ensure the player-container takes 50% of the container's width */
        }
        #player {
            width: 100%; /* Ensure the player takes the whole width of its container */
        }
        #subtitles {
            flex: 1;
            overflow-y: scroll;
            padding: 10px;
        }
        .subtitle {
            cursor: pointer;
            margin-bottom: 5px; /* Decreased margin */
            padding: 2px; /* Decreased padding */
        }
        #top-bar {
            display: flex;
            background-color: #f0f0f0; /* or any color of your choice */
            padding: 5px;
        }
        .recent-media {
            margin-right: 10px;
            cursor: pointer;
            text-decoration: underline;
        }
        .subtitle:hover, .subtitle.active {
            background-color: #eaeaea;
        }
        .subtitle.active {
            border: 1px solid #000;
        }
    </style>
</head>
<body>
<div id="top-bar">
    <!-- Recent Media Files will be added by JavaScript -->
</div>
<div id="container">
    <div id="player-container">
        <audio id="player" playsinline controls>
            <source src="/media/by10m_03.mp3" type="audio/mp3" />
            <track kind="captions" label="English captions" src="/media/by10m_03.vtt" srclang="en" default />
        </audio>
    </div>
    <div id="subtitles">
        <!-- Subtitle lines will be added by JavaScript -->
    </div>
</div>

<script src="https://cdn.plyr.io/3.6.8/plyr.polyfilled.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const player = new Plyr('#player');
        const subtitlesContainer = document.getElementById('subtitles');
        const playerContainer = document.getElementById('player-container');
        playerContainer.addEventListener('click', function () {
            player.togglePlay();
        });
        let subtitles = [];
        let activeSubtitleIndex = null;

        fetch('/media')
            .then(response => response.json())
            .then(data => {
                const topBar = document.getElementById('top-bar');
                data.media_files.slice(0, 5).forEach(file => {
                    const span = document.createElement('span');
                    span.className = 'recent-media';
                    span.textContent = file;
                    span.addEventListener('click', function () {
                        const mediaType = file.split('.').pop();
                        if (mediaType === 'mp3' || mediaType === 'mp4' || mediaType === 'mkv') {
                            player.source = {
                                type: mediaType === 'mp3' ? 'audio' : 'video',
                                sources: [{ src: `/media/${file}`, type: `${mediaType === 'mp3' ? 'audio' : 'video'}/${mediaType}` }],
                            };
                        }
                        // Load the corresponding VTT file
                        loadSubtitles(file.replace(/\.[^/.]+$/, ".vtt"));
                    });
                    topBar.appendChild(span);
                });
            });

            function loadSubtitles(vttFileName) {
                // Clear existing subtitles
                subtitlesContainer.innerHTML = '';
                subtitles = [];
                activeSubtitleIndex = null;
                
                fetch(`/media/${vttFileName}`)
                    .then(response => response.text())
                    .then(data => {
                        const regex = /(\d\d:\d\d:\d\d\.\d\d\d) --> (\d\d:\d\d:\d\d\.\d\d\d)\n([\s\S]*?)(?=\n\d\d:\d\d:\d\d\.\d\d\d --> \d\d:\d\d:\d\d\.\d\d\d|\n*$)/g;
                        let match;
                        while (match = regex.exec(data)) {
                            const [_, start, end, text] = match;
                            const div = document.createElement('div');
                            div.className = 'subtitle';
                            div.textContent = text.trim();
                            div.dataset.start = start;
                            div.dataset.end = end;
                            div.addEventListener('click', function () {
                                setActiveSubtitle(div);
                                player.currentTime = parseTime(this.dataset.start);
                                player.play(); // Ensure the player starts playing
                            });
                            subtitlesContainer.appendChild(div);
                            subtitles.push(div);
                        }
                    });
            }

        player.on('timeupdate', function () {
            for (let i = 0; i < subtitles.length; i++) {
                const start = parseTime(subtitles[i].dataset.start);
                const end = parseTime(subtitles[i].dataset.end);
                if (player.currentTime >= start && player.currentTime <= end) {
                    setActiveSubtitle(subtitles[i]);
                    break;
                }
            }
        });

        window.addEventListener('keydown', function (event) {
            if (event.code === 'Space') {
                event.preventDefault();
                player.togglePlay();
            } else if (event.code === 'ArrowLeft' && activeSubtitleIndex > 0) {
                event.preventDefault();
                setActiveSubtitle(subtitles[activeSubtitleIndex - 1]);
                player.currentTime = parseTime(subtitles[activeSubtitleIndex].dataset.start);
            } else if (event.code === 'ArrowRight' && activeSubtitleIndex < subtitles.length - 1) {
                event.preventDefault();
                setActiveSubtitle(subtitles[activeSubtitleIndex + 1]);
                player.currentTime = parseTime(subtitles[activeSubtitleIndex].dataset.start);
            } else if (event.code === 'ArrowDown') {
                event.preventDefault();
                setActiveSubtitle(subtitles[activeSubtitleIndex]);
                player.currentTime = parseTime(subtitles[activeSubtitleIndex].dataset.start);
            }
        });

        function setActiveSubtitle(subtitle) {
            if (activeSubtitleIndex !== null) subtitles[activeSubtitleIndex].classList.remove('active');
            activeSubtitleIndex = subtitles.indexOf(subtitle);
            if (activeSubtitleIndex !== -1) subtitles[activeSubtitleIndex].classList.add('active');
        }

        function parseTime(timeString) {
            const [hours, minutes, seconds] = timeString.split(':').map(parseFloat);
            return hours * 3600 + minutes * 60 + seconds;
        }
    });
</script>
</body>
</html>
